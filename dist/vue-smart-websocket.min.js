!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("smart-websocket"),require("lodash"),require("vue")):"function"==typeof define&&define.amd?define(["smart-websocket","lodash","vue"],t):e["vue-smart-websocket"]=t(e.SmartWebsocket,e._,e.Vue)}(this,function(e,t,n){"use strict";function o(e){return!!e.$vnode}function s(e){s.installed||(s.installed=!0,e.mixin({beforeCreate:function(){u(this.$options.ws)?(this.$_wsRoot=this,this._ws=this.$options.ws,this._ws.init()):this.$_wsRoot=this.$parent&&this.$parent.$_wsRoot||this},destroyed:function(){var e=this.$_wsRoot._ws;e.off(this),u(this.$options.ws)&&e.destroy()}}),Object.defineProperty(e.prototype,"$ws",{get:function(){var e=this;return{on:function(t,n){e.$_wsRoot._ws.on(e,t,n)},off:function(t){e.$_wsRoot._ws.off(e,t)},send:function(t){e.$_wsRoot._ws.send(t)}}}}))}function r(e,t){if(!e)throw new Error(t)}function i(e){var t=JSON.parse(e);return[t.type,t.body]}e="default"in e?e.default:e,n="default"in n?n.default:n;var u=function(e){return void 0!==e},c="undefined"!=typeof window,f=function(e,t){return function(){for(var n=[],o=arguments.length;o--;)n[o]=arguments[o];try{return e.apply(null,n)}catch(e){throw Object.assign(e,{message:t||e.message})}}},a=function(t){this.bus=new n,this.listeners=[];var o=t.url,s=t.debug,r=t.parse;void 0===r&&(r=i),this.parse=f(r,"解析错误"),this.debug=s,this.socket=new e(o,t)};return a.prototype.init=function(){var e=this,t=this,n=t.debug,o=t.socket;n&&(o.addEventListener("connecting",function(e){var t=e.reconnectCount;return console.log("[ws] connecting",t)}),o.addEventListener("open",function(e){var t=e.reconnectCount;return console.log("[ws] open",t)}),o.addEventListener("close",function(e){var t=e.reconnectCount;return console.log("[ws] close",t)}),o.addEventListener("error",function(e){var t=e.reconnectCount;return console.log("[ws] error",t)})),o.addEventListener("message",function(t){var n=(t.reconnectCount,t.data);try{var o=e.parse(n),s=o[0],i=o[1];r(s,"类型错误"),e.emit(s,i)}catch(e){console.error(e)}})},a.prototype.destroy=function(){var e=["connecting","open","close","error","message"];this.bus.$off(),e.forEach(this.socket.removeEventListener.bind(this.socket))},a.prototype.genKey=function(e){var t=e.$vnode||{};return o(e)?t.key||(t.isComment?"comment":t.tag):e},a.prototype.emit=function(e,n){var o=this;this.listeners.filter(function(n){var o=n.type;return t.isRegExp(o)?o.test(e):o===e}).forEach(function(e){var t=e.event;o.bus.$emit(t,n)})},a.prototype.on=function(e,t,n){var o=this.genKey(e),s=o+":"+t,r=this.listeners.concat({key:o,type:t,event:s});this.listeners=r,this.bus.$on(s,n),this.debug&&console.log("[ws] addListeners",r,this.listeners)},a.prototype.off=function(e,n){var o=this,s=this.genKey(e),r=t.groupBy(this.listeners,function(e){var t=e.key,o=e.type;return s!==t||n&&n!==o?"remain":"filter"}),i=r.filter;void 0===i&&(i=[]);var u=r.remain;void 0===u&&(u=[]),this.listeners=u,i.forEach(function(e){var t=e.event;return o.bus.$off(t)}),this.debug&&i.length&&console.log("[ws] removeListeners",i,this.listeners)},a.prototype.send=function(e){this.socket.send(JSON.stringify(e))},a.install=s,a.version="1.1.0",c&&window.Vue&&window.Vue.use(a),a});
